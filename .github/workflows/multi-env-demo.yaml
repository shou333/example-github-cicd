name: Multi-line Environment Variable Issue Demo

on: workflow_dispatch

jobs:
  extract-content:
    runs-on: ubuntu-latest
    outputs:
      content: ${{ steps.extract.outputs.content }}
    steps:
      - name: Extract multi-line DDL content
        id: extract
        run: |
          CONTENT="CREATE TABLE eportal_tool_deliver (
            eportal_tool_deliver BINARY(16) NOT NULL,
            eportal_tool_id INT NOT NULL,
            directory_id INT NOT NULL,
            PRIMARY KEY (eportal_tool_deliver, eportal_tool_id, directory_id)
          );
          CREATE TABLE offline_wb (
            offline_wb BINARY(16) NOT NULL,
            wb_content_id INT NOT NULL,
            created_at TIMESTAMP
          );"

          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  demonstrate-problem-and-solution:
    needs: extract-content
    if: needs.extract-content.outputs.content != null
    runs-on: ubuntu-latest

    steps:
      - name: "âŒ PROBLEMATIC APPROACH - Using env variable"
        continue-on-error: true
        run: |
          echo "========================================="
          echo "PROBLEMATIC: Using environment variable"
          echo "========================================="
          echo ""
          echo "Workflow configuration:"
          echo "  env:"
          echo "    sql_content: \${{ needs.extract-content.outputs.content }}"
          echo "  run: |"
          echo "    echo \"\${{ env.sql_content }}\" > query.sql"
          echo "    mysql ... < query.sql"
          echo ""
          echo "What GitHub Actions does internally:"
          echo "  Generates a temp script like:"
          echo "    sql_content=CREATE TABLE eportal_tool_deliver ("
          echo "      eportal_tool_deliver BINARY(16) NOT NULL,"
          echo "      ..."
          echo ""
          echo "This causes: syntax error near unexpected token '('"
          echo ""
          echo "Attempting this approach now..."
          echo ""

          # This will fail with syntax error
          export sql_content=${{ needs.extract-content.outputs.content }}
          echo "$sql_content" > /tmp/query.sql 2>&1 || echo "âœ— Failed as expected"

      - name: "âœ… CORRECT APPROACH - Using heredoc"
        run: |
          echo ""
          echo "========================================="
          echo "CORRECT: Using heredoc syntax"
          echo "========================================="
          echo ""
          echo "Workflow configuration:"
          echo "  run: |"
          echo "    mysql << 'EOF'"
          echo "    \${{ needs.extract-content.outputs.content }}"
          echo "    EOF"
          echo ""
          echo "Why this works:"
          echo "  âœ“ No environment variable intermediate step"
          echo "  âœ“ Content passed directly to command stdin"
          echo "  âœ“ No bash parsing of the content"
          echo "  âœ“ No syntax errors"
          echo ""
          echo "Demonstrating this approach:"
          echo ""

          # This works correctly
          cat << 'SQLEOF' > /tmp/query.sql
          ${{ needs.extract-content.outputs.content }}
          SQLEOF

          echo "âœ“ Successfully created file:"
          ls -lh /tmp/query.sql
          echo ""
          echo "File contents:"
          cat /tmp/query.sql
          echo ""
          echo "âœ“ Perfect - no errors!"

      - name: "ðŸ“Š ROOT CAUSE ANALYSIS"
        run: |
          echo ""
          echo "========================================="
          echo "ROOT CAUSE: How GitHub Actions handles env vars"
          echo "========================================="
          echo ""
          echo "When you use:"
          echo "  env:"
          echo "    content: \${{ needs.extract-content.outputs.content }}"
          echo ""
          echo "GitHub Actions generates a temporary bash script:"
          echo ""
          echo "  #!/bin/bash"
          echo "  set -e"
          echo "  export content='CREATE TABLE eportal_tool_deliver ("
          echo "    eportal_tool_deliver BINARY(16) NOT NULL,"
          echo "    eportal_tool_id INT NOT NULL,"
          echo "    directory_id INT NOT NULL,"
          echo "    PRIMARY KEY (eportal_tool_deliver, eportal_tool_id, directory_id)"
          echo "  );'"
          echo ""
          echo "BUT if not properly quoted, it becomes:"
          echo ""
          echo "  #!/bin/bash"
          echo "  set -e"
          echo "  export content=CREATE TABLE eportal_tool_deliver ("
          echo "    eportal_tool_deliver BINARY(16) NOT NULL,"
          echo ""
          echo "This causes bash to parse:"
          echo "  - 'export content=CREATE' â†’ set variable"
          echo "  - 'TABLE' â†’ undefined command"
          echo "  - 'eportal_tool_deliver' â†’ undefined command"
          echo "  - '(' â†’ syntax error"
          echo ""
          echo "Result: syntax error near unexpected token '('"
          echo ""
          echo "========================================="
          echo "SOLUTION: Use heredoc instead"
          echo "========================================="
          echo ""
          echo "Heredoc passes content directly to stdin:"
          echo ""
          echo "  cat << 'EOF' > query.sql"
          echo "  \${{ needs.extract-content.outputs.content }}"
          echo "  EOF"
          echo ""
          echo "This way:"
          echo "  âœ“ No variable expansion"
          echo "  âœ“ No bash parsing"
          echo "  âœ“ Content is literal text"
          echo "  âœ“ All special characters preserved"
          echo ""
