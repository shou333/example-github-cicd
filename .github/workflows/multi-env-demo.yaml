name: Multi-line Environment Variable Issue Demo

on: workflow_dispatch

jobs:
  extract-content:
    runs-on: ubuntu-latest
    outputs:
      content: ${{ steps.extract.outputs.content }}
    steps:
      - name: Extract multi-line DDL
        id: extract
        run: |
          # Simulate extracting DDL from migration files
          CONTENT="-- V231__CreateEportalToolDeliver
          CREATE TABLE eportal_tool_deliver (
            eportal_tool_deliver BINARY(16) NOT NULL,
            eportal_tool_id INT NOT NULL,
            directory_id INT NOT NULL,
            PRIMARY KEY (eportal_tool_deliver, eportal_tool_id, directory_id)
          );
          CREATE TABLE offline_wb (
            offline_wb BINARY(16) NOT NULL,
            wb_content_id INT NOT NULL
          );"

          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  real-error-demo:
    needs: extract-content
    if: needs.extract-content.outputs.content != null
    runs-on: ubuntu-latest

    steps:
      - name: "âŒ REAL ERROR REPRODUCTION - This will show command not found"
        continue-on-error: true
        run: |
          echo "=== REPRODUCING THE EXACT ERROR ==="
          echo ""
          echo "Creating a script that simulates GitHub Actions temp script generation"
          echo "When env variables with multi-line content are not properly quoted"
          echo ""

          # Create the problematic script
          cat > /tmp/problematic_ga_script.sh << 'BADSCRIPT'
          #!/bin/bash
          set -e

          # This is what GitHub Actions does when you have:
          # env:
          #   sql: ${{ needs.extract-content.outputs.content }}
          #
          # If the content isn't properly quoted, it creates a script like this:

          sql=-- V231__CreateEportalToolDeliver
          CREATE TABLE eportal_tool_deliver (
            eportal_tool_deliver BINARY(16) NOT NULL,
            eportal_tool_id INT NOT NULL,
            directory_id INT NOT NULL,
            PRIMARY KEY (eportal_tool_deliver, eportal_tool_id, directory_id)
          );
          CREATE TABLE offline_wb (
            offline_wb BINARY(16) NOT NULL,
            wb_content_id INT NOT NULL
          );

          # Then the workflow tries to use it:
          echo "This line will never execute"
          BADSCRIPT

          echo "Generated problematic script:"
          cat /tmp/problematic_ga_script.sh
          echo ""
          echo "Executing it..."
          echo ""

          bash /tmp/problematic_ga_script.sh 2>&1 || echo ""

      - name: "âœ… SOLUTION - Direct heredoc usage (no environment variable)"
        run: |
          echo ""
          echo "=== CORRECT APPROACH: USING HEREDOC ==="
          echo ""

          # The solution: don't use env variables for multi-line content
          # Instead, use heredoc directly with the output

          echo "Approach 1: Direct heredoc with command output"
          cat << 'EOF'
          -- V231__CreateEportalToolDeliver
          CREATE TABLE eportal_tool_deliver (
            eportal_tool_deliver BINARY(16) NOT NULL,
            eportal_tool_id INT NOT NULL,
            directory_id INT NOT NULL,
            PRIMARY KEY (eportal_tool_deliver, eportal_tool_id, directory_id)
          );
          CREATE TABLE offline_wb (
            offline_wb BINARY(16) NOT NULL,
            wb_content_id INT NOT NULL
          );
          EOF

          echo ""
          echo "âœ… SUCCESS - No 'command not found' errors!"

      - name: "âœ… SOLUTION - Using job output with heredoc"
        run: |
          echo ""
          echo "=== RECOMMENDED: Job output with heredoc ==="
          echo ""

          # Instead of:
          # env:
          #   content: ${{ needs.extract-content.outputs.content }}
          # run: |
          #   echo "${{ env.content }}" > file.sql

          # Use this:
          cat << 'EOF' > /tmp/output.sql
          ${{ needs.extract-content.outputs.content }}
          EOF

          echo "Generated SQL file:"
          cat /tmp/output.sql

          echo ""
          echo "âœ… SUCCESS - Multi-line content safely handled!"
          rm /tmp/output.sql

      - name: "ðŸ“Š Detailed Analysis"
        run: |
          echo ""
          echo "========================================="
          echo "WHY THE ERROR HAPPENS"
          echo "========================================="
          echo ""
          echo "PROBLEM WORKFLOW:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "check-migration:"
          echo "  needs: extract-content"
          echo "  env:"
          echo "    sql: \${{ needs.extract-content.outputs.content }}  âš ï¸ Multi-line!"
          echo "  run: |"
          echo "    echo \"\${{ env.sql }}\" > query.sql"
          echo "    mysql ... < query.sql"
          echo ""
          echo "What happens:"
          echo "  1. GitHub Actions receives multi-line output from extract-content"
          echo "  2. GitHub Actions tries to set it as an environment variable"
          echo "  3. Generates a temporary script like:"
          echo ""
          echo "     sql=CREATE TABLE eportal_tool_deliver ("
          echo "       eportal_tool_deliver BINARY(16),"
          echo "       ..."
          echo "     );"
          echo ""
          echo "  4. Bash sees this as: ASSIGN sql=CREATE, then execute TABLE, then execute eportal_tool_deliver"
          echo "  5. Result: 'command not found: eportal_tool_deliver'"
          echo ""
          echo ""
          echo "CORRECT APPROACH:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo ""
          echo "run: |"
          echo "  mysql << 'EOF'"
          echo "  \${{ needs.extract-content.outputs.content }}"
          echo "  EOF"
          echo ""
          echo "Why it works:"
          echo "  1. Heredoc passes content directly to command's stdin"
          echo "  2. No environment variable intermediate step"
          echo "  3. No bash parsing of the content"
          echo "  4. Table names treated as literal text, never as commands"
          echo "  5. âœ… No 'command not found' errors!"
          echo ""
